[Unit]
Description=Lawnberry Hardware Sensor Service
After=network-online.target mosquitto.service
Wants=network-online.target mosquitto.service
StartLimitIntervalSec=0

[Service]
Type=exec
User=pi
Group=pi
# Use a writable working directory so lgpio can create its notification pipes (.lgd-nfy*)
WorkingDirectory=/var/lib/lawnberry
Environment=PYTHONPATH=/opt/lawnberry
Environment=LAWNBERRY_ENV=production
Environment=LOG_LEVEL=INFO
# Ensure gpiozero uses lgpio on Bookworm (more reliable on Pi 4/5)
Environment=GPIOZERO_PIN_FACTORY=lgpio
Environment=LAWNBERY_TOF_NO_GPIO=always
# Optional: enable one-time address assignment if a sensor is missing at startup (0/1)
Environment=LAWNBERY_TOF_AUTO_ASSIGN_ON_MISSING=1
# Optional: max seconds to allow the auto-assign script to run
Environment=LAWNBERY_TOF_AUTO_ASSIGN_TIMEOUT_S=60
ExecStart=/opt/lawnberry/venv/bin/python -m src.hardware.sensor_service
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=5
StartLimitBurst=5
TimeoutStopSec=20
KillMode=mixed

# Resource limits
MemoryMax=256M
CPUQuota=100%
TasksMax=100

# Security settings
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
# Allow writes to logs and state dir (working dir). Do NOT list device nodes here:
# ReadWritePaths expects existing directories/files; listing absent device nodes causes NAMESPACE failures.
# Device access is controlled below via DeviceAllow entries.
ReadWritePaths=/var/log/lawnberry /var/lib/lawnberry
DeviceAllow=/dev/i2c-1 rw
DeviceAllow=/dev/serial0 rw
DeviceAllow=/dev/ttyAMA4 rw
DeviceAllow=/dev/ttyAMA1 rw
DeviceAllow=/dev/ttyS1 rw
DeviceAllow=/dev/ttyACM0 rw
DeviceAllow=/dev/ttyACM1 rw
DeviceAllow=/dev/ttyACM2 rw
DeviceAllow=/dev/video0 rw
DeviceAllow=/dev/video1 rw
DeviceAllow=/dev/video2 rw
DeviceAllow=/dev/video3 rw
DeviceAllow=/dev/video4 rw
DeviceAllow=/dev/video5 rw
DeviceAllow=/dev/video6 rw
DeviceAllow=/dev/video7 rw
DeviceAllow=/dev/media0 rw
DeviceAllow=/dev/media1 rw
DeviceAllow=/dev/media2 rw
DeviceAllow=/dev/media3 rw
DeviceAllow=/dev/gpiochip0 rw
DeviceAllow=/dev/gpiochip1 rw
PrivateTmp=true
ProtectKernelTunables=true
ProtectControlGroups=true
RestrictRealtime=true
SystemCallFilter=@system-service
SystemCallErrorNumber=EPERM

# Hardware access
SupplementaryGroups=gpio i2c spi dialout

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=lawnberry-sensor

[Install]
WantedBy=multi-user.target
