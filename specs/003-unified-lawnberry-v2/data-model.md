# Data Model — LawnBerry Pi v2 Unified System

## Core System Entities

### SensorReading
- **Description**: Standardized sensor data structure for all hardware measurements
- **Identifiers**: Composite key of `sensor_id` + `timestamp`
- **Fields**:
  - `sensor_id` (string, required)
  - `timestamp` (datetime, required)
  - `value` (float, required)
  - `unit` (string, required)
  - `quality` (float, 0.0-1.0, confidence/accuracy indicator)
  - `bus_type` (enum: I2C, UART, GPIO, USB)
  - `bus_address` (string, bus-specific addressing)
  - `metadata` (dict, sensor-specific additional data)
- **Relationships**:
  - Consumed by NavigationState for positioning
  - Aggregated into TelemetrySnapshot for WebUI
  - Archived in OperationalData for analytics
- **Validation Rules**:
  - INA3221 readings must respect constitutional channel assignments
  - I2C addresses must match hardware.yaml specifications
  - UART sensors must use designated ports (BNO085 on UART4)

### NavigationState
- **Description**: Current mower position, path planning, and movement control
- **Identifiers**: `state_id` (UUID)
- **Fields**:
  - `position` (GPSCoordinate, current location)
  - `heading` (float, degrees 0-359.9)
  - `velocity` (float, m/s)
  - `planned_path` (array of GPSCoordinate waypoints)
  - `obstacle_map` (spatial grid of detected obstacles)
  - `gps_mode` (enum: rtk_usb, uart_fallback)
  - `navigation_quality` (float, 0.0-1.0)
  - `safety_constraints` (SafetyParameters)
- **Relationships**:
  - Consumes SensorReading from GPS, IMU, encoders
  - Drives MotorCommand for movement execution
  - Updates WebUIPage dashboard and manual control
- **Validation Rules**:
  - GPS mode must be exclusive (ZED-F9P USB OR Neo-8M UART, not both)
  - Planned paths must respect defined boundaries and exclusion zones
  - Safety constraints must override all navigation decisions

### MotorCommand
- **Description**: Motor control instructions for propulsion and cutting systems
- **Identifiers**: `command_id` (UUID)
- **Fields**:
  - `motor_type` (enum: propulsion, cutting)
  - `controller_type` (enum: robohat_cytron, l298n_fallback, ibt4_blade)
  - `speed` (float, -1.0 to 1.0 normalized)
  - `direction` (enum: forward, reverse, left, right, stop)
  - `duration_ms` (integer, command duration)
  - `safety_interlocks` (array of safety check results)
  - `issued_at` (datetime)
  - `executed_at` (datetime, nullable)
- **Relationships**:
  - Generated by NavigationState for autonomous operation
  - Created by WebUIPage manual control for user commands
  - Monitored by SafetySystem for emergency stops
- **Validation Rules**:
  - Cutting system commands must verify safety interlocks
  - Manual commands require authenticated user session
  - All commands must respect emergency stop state
  - Propulsion movement commands MUST be transmitted via serial to the RoboHAT RP2040 running `robohat_files/code.py` (firmware should remain unmodified unless hall-effect support is required)

### SafetySystem
- **Description**: Safety monitoring, hazard detection, and emergency response
- **Identifiers**: `safety_state_id` (UUID)
- **Fields**:
  - `emergency_stop_active` (boolean)
  - `tilt_detected` (boolean)
  - `obstacle_proximity` (float, meters to nearest obstacle)
  - `blade_safety_state` (enum: safe, caution, emergency)
  - `active_alerts` (array of SafetyAlert)
  - `last_safety_check` (datetime)
  - `safety_protocol_version` (string)
- **Relationships**:
  - Monitors all SensorReading for hazard conditions
  - Can override any MotorCommand for safety
  - Publishes alerts to WebSocketTopic for immediate UI updates
- **Validation Rules**:
  - Emergency stop must immediately halt all motors
  - Tilt detection must trigger blade safety cutoff
  - Safety checks must complete within 100ms

### RCStatus
- **Description**: RC/USB control status snapshot reported by RoboHAT RP2040
- **Identifiers**: `snapshot_id` (UUID)
- **Fields**:
  - `rc_enabled` (boolean)
  - `rc_mode` (enum: emergency, manual, assisted, training)
  - `signal_lost` (boolean)
  - `blade_enabled` (boolean)
  - `channels` (map<int, microseconds>)
  - `encoder_ticks` (integer)
  - `hall_left` (integer, optional)
  - `hall_right` (integer, optional)
- **Validation Rules**:
  - Presence of `hall_left` and `hall_right` depends on firmware support in `robohat_files/code.py`

## Power Management Entities

### PowerSystem
- **Description**: Battery, solar, and power consumption monitoring per constitutional requirements
- **Identifiers**: `power_state_id` (UUID)
- **Fields**:
  - `battery_voltage` (float, volts)
  - `battery_current` (float, amps)
  - `battery_percentage` (float, 0-100)
  - `solar_voltage` (float, volts)
  - `solar_current` (float, amps)
  - `consumption_rate` (float, watts)
  - `charging_state` (enum: charging, discharging, idle)
  - `ina3221_channels` (fixed mapping per constitution)
- **Relationships**:
  - Sources from SensorReading INA3221 at I2C 0x40
  - Triggers NavigationState return-to-base decisions
  - Updates WebUIPage dashboard power status
- **Validation Rules**:
  - Channel 1 must always be Battery (constitutional requirement)
  - Channel 2 must remain Unused (constitutional requirement)
  - Channel 3 must always be Solar Panel (constitutional requirement)
  - Low battery must trigger automated return/idle behavior (no docking), selecting Home or Sun locations as appropriate
  - Sun-seeking behavior selects AM Sun vs PM Sun vs Home depending on time-of-day and available sunlight

## AI & Vision Entities

### AIAccelerator
- **Description**: Hardware acceleration tier management per constitutional hierarchy
- **Identifiers**: `accelerator_id` (string)
- **Fields**:
  - `accelerator_type` (enum: coral_usb, hailo_hat, cpu_fallback)
  - `priority_order` (integer, 1=highest)
  - `isolated_environment` (boolean, true for Coral)
  - `device_status` (enum: available, unavailable, error)
  - `performance_metrics` (dict, inference times, etc.)
  - `model_compatibility` (array of supported model formats)
- **Relationships**:
  - Used by VisionProcessing for object detection
  - Managed by AITrainingJob for model inference
  - Configured via WebUIPage settings
- **Validation Rules**:
  - Coral must run in isolated venv-coral environment
  - pycoral/edgetpu packages banned from main environment
  - Graceful degradation required when hardware unavailable

### VisionProcessing
- **Description**: Camera stream processing and AI-based object detection
- **Identifiers**: `frame_id` (UUID)
- **Fields**:
  - `camera_source` (enum: picamera2)
  - `frame_timestamp` (datetime)
  - `frame_resolution` (string, e.g., "1920x1080")
  - `detected_objects` (array of ObjectDetection)
  - `processing_latency_ms` (float)
  - `accelerator_used` (reference to AIAccelerator)
  - `confidence_threshold` (float, 0.0-1.0)
- **Relationships**:
  - Consumes camera stream via exclusive service ownership
  - Uses AIAccelerator for processing
  - Feeds obstacle data to NavigationState
  - Provides imagery to AITrainingJob
- **Validation Rules**:
  - Camera access must be exclusive to camera service
  - Other components consume frames via IPC, never direct camera access
  - Processing must respect constitutional acceleration hierarchy

### ToFOrientation
- **Description**: Clarifies physical orientation of ToF sensors
- **Identifiers**: `id` (singleton)
- **Fields**:
  - `left_sensor` (string, value: "front-left")
  - `right_sensor` (string, value: "front-right")
- **Validation Rules**:
  - Left/Right MUST be interpreted as front-left/front-right, respectively

## WebUI System Entities

### MapProviderPreference
- **Description**: Preferred map provider for map-based UI
- **Identifiers**: `id` (singleton)
- **Fields**:
  - `provider` (enum: google_maps, openstreetmap)
  - `cost_optimization_enabled` (boolean, default true)
- **Validation Rules**:
  - Default MUST be google_maps with cost optimization enabled
  - Users MAY switch to openstreetmap at any time

### MapBoundary
- **Description**: User-defined yard/mowing boundary polygon
- **Identifiers**: `boundary_id` (UUID)
- **Fields**:
  - `name` (string)
  - `polygon` (array of GPSCoordinate in winding order)
  - `exclusions` (array of polygons)
  - `updated_at` (datetime)
- **Validation Rules**:
  - Polygon MUST be non-self-intersecting
  - Exclusions MUST be fully contained within the boundary
  - Coordinates MUST be valid GPS lat/lon pairs

### SunLocation
- **Description**: Preferred sun exposure staging locations
- **Identifiers**: `sun_location_id` (UUID)
- **Fields**:
  - `type` (enum: am_sun, pm_sun)
  - `position` (GPSCoordinate)
  - `updated_at` (datetime)
- **Validation Rules**:
  - Only one AM Sun and one PM Sun may exist

### HomeLocation
- **Description**: Default idle/return location when not mowing or sun-seeking
- **Identifiers**: `home_location_id` (UUID)
- **Fields**:
  - `position` (GPSCoordinate)
  - `updated_at` (datetime)
- **Validation Rules**:
  - Must be within the MapBoundary polygon

### WebUIPage
- **Description**: Canonical record of the seven mandated WebUI pages
- **Identifiers**: `slug` (dashboard, map-setup, manual-control, mow-planning, ai-training, settings, docs-hub)
- **Fields**:
  - `display_name` (string, required)
  - `primary_goal` (string, required)
  - `route_path` (string, required; /dashboard, /map-setup, etc.)
  - `rest_dependencies` (array of RestContract.id, ≥1 required)
  - `ws_topics` (array of WebSocketTopic.name, optional for docs-hub)
  - `telemetry_requirements` (TelemetryRequirements object)
  - `authentication_required` (boolean, true for manual control)
  - `simulation_support` (boolean, must be true per constitution)
  - `branding_assets` (array of BrandAsset references)
- **Relationships**:
  - References RestContract for data endpoints
  - Subscribes to WebSocketTopic for real-time updates
  - Uses BrandAsset for retro 1980s aesthetic
  - Protected by OperatorCredential for sensitive operations
- **Validation Rules**:
  - Route path must begin with /
  - Pages requiring live state must include ≥1 WebSocket topic
  - Manual control must require authentication
  - All pages must support simulation mode

### TelemetryStream
- **Description**: Real-time data streams for WebUI updates
- **Identifiers**: `topic` (e.g., telemetry/updates, map/updates)
- **Fields**:
  - `cadence_hz` (float, default 5.0, range 1.0-10.0)
  - `burst_max_hz` (float, default 10.0)
  - `diagnostic_floor_hz` (float, default 1.0)
  - `payload_schema` (JSON Schema reference)
  - `source_service` (string, e.g., mower-core, navigation)
  - `critical` (boolean, alerts if stream stalls >3s)
  - `heartbeat_interval_sec` (integer, default 1)
  - `supports_backfill` (boolean, for historical data)
- **Relationships**:
  - Consumed by WebUIPage for real-time updates
  - Managed by WebSocketHub for client distribution
  - Configured by TelemetryCadencePolicy
- **Validation Rules**:
  - Cadence range must be 1.0-10.0 Hz per constitutional requirements
  - Critical streams must include heartbeat monitoring
  - Diagnostic mode must support 1Hz fallback

### WebSocketHub
- **Description**: Central communication hub for real-time WebUI updates
- **Identifiers**: `hub_instance_id` (singleton)
- **Fields**:
  - `active_connections` (integer, current client count)
  - `topic_subscriptions` (dict, topic -> client mappings)
  - `telemetry_cadence_hz` (float, current broadcast rate)
  - `connection_stats` (dict, performance metrics)
  - `last_heartbeat` (datetime)
- **Relationships**:
  - Manages all WebSocketTopic subscriptions
  - Distributes TelemetryStream data to clients
  - Coordinates with RestContract for HTTP/WS consistency
- **Validation Rules**:
  - Must maintain <100ms telemetry latency
  - Client connections must be properly managed
  - Topic routing must be efficient and reliable

### RestContract
- **Description**: REST API endpoint definitions supporting WebUI functionality
- **Identifiers**: `id` (URI path + method, e.g., GET /api/dashboard/state)
- **Fields**:
  - `method` (enum: GET, POST, PUT, PATCH, DELETE)
  - `path` (string, API endpoint path)
  - `request_schema` (JSON Schema, nullable for GET)
  - `response_schema` (JSON Schema, required)
  - `auth_required` (boolean, true except docs endpoints)
  - `roles_allowed` (array, currently ["operator"])
  - `cache_ttl_seconds` (integer, optional)
  - `linked_topics` (array of WebSocketTopic names)
- **Relationships**:
  - Referenced by WebUIPage for data operations
  - May trigger WebSocketTopic broadcasts
  - Protected by OperatorCredential when auth_required
- **Validation Rules**:
  - Manual control endpoints must require authentication
  - Response schemas must be complete and valid
  - Cache strategies must align with data freshness needs

## Configuration & Operations Entities

### OperatorCredential
- **Description**: Authentication system for WebUI access
- **Identifiers**: `id` (currently "operator-shared")
- **Fields**:
  - `username` (string, required)
  - `password_hash` (string, secure storage)
  - `permissions` (set: view, control, export)
  - `last_rotated_at` (datetime, nullable)
  - `active_sessions` (array of session identifiers)
- **Relationships**:
  - Required by RestContract where auth_required=true
  - Gates manual control operations in WebUIPage
  - Logs access for DatasetExportJob traceability
- **Validation Rules**:
  - Manual control commands must verify credentials
  - Password rotation must be supported
  - Session management must be secure

### HardwareProfile
- **Description**: Hardware configuration matching constitutional requirements
- **Identifiers**: `component` (e.g., gps, imu, ai_acceleration)
- **Fields**:
  - `preferred` (dict, primary hardware choice)
  - `alternatives` (array, fallback options)
  - `conflicts` (array, incompatible combinations)
  - `required_buses` (array: I2C, UART4, USB)
  - `priority_order` (array, preference hierarchy)
  - `exclusive_group` (string, mutual exclusion)
  - `constitutional_requirements` (dict, immutable constraints)
- **Relationships**:
  - Validates SensorReading source configurations
  - Guides AIAccelerator selection and isolation
  - Enforces PowerSystem channel assignments
- **Validation Rules**:
  - GPS modes must be mutually exclusive
  - HAT stacking conflicts must be prevented
  - INA3221 channels must match constitutional assignments
  - AI acceleration must follow isolation requirements

### SystemConfiguration
- **Description**: Operational parameters and user preferences
- **Identifiers**: `config_id` (UUID)
- **Fields**:
  - `hardware_detected` (HardwareProfile snapshot)
  - `user_preferences` (dict, customizable settings)
  - `calibration_data` (dict, sensor calibrations)
  - `simulation_mode` (boolean, SIM_MODE flag)
  - `telemetry_overrides` (TelemetryCadencePolicy settings)
  - `maintenance_schedule` (dict, service intervals)
  - `version_info` (dict, software/firmware versions)
- **Relationships**:
  - Configures all system components
  - Persisted for migration and backup
  - Updated via WebUIPage settings
- **Validation Rules**:
  - Hardware detection must match constitutional requirements
  - Simulation mode must provide complete coverage
  - Configuration changes must be validated and versioned

### OperationalData
- **Description**: Historical data, analytics, and performance metrics
- **Identifiers**: `data_id` (UUID)
- **Fields**:
  - `operation_type` (enum: mowing, charging, maintenance)
  - `start_time` (datetime)
  - `end_time` (datetime)
  - `performance_metrics` (dict, KPIs and measurements)
  - `sensor_data_archive` (array of SensorReading)
  - `events_log` (array of system events)
  - `user_actions` (array of manual interventions)
- **Relationships**:
  - Archives SensorReading for analytics
  - Tracks NavigationState performance
  - Provides data for WebUIPage reporting
- **Validation Rules**:
  - Data integrity must be maintained
  - Privacy considerations for user data
  - Backup and recovery procedures required

## AI Training & Export Entities

### DatasetExportJob
- **Description**: AI training dataset export management
- **Identifiers**: `job_id` (UUID)
- **Fields**:
  - `requested_formats` (set ⊆ {coco-json, yolo-txt}, required ≥1)
  - `status` (enum: queued, running, complete, failed)
  - `image_count` (integer, total images to export)
  - `submitted_by` (OperatorCredential.id reference)
  - `submitted_at` (datetime)
  - `completed_at` (datetime, nullable)
  - `artifact_urls` (dict, format -> download URL)
  - `export_metadata` (dict, quality metrics, annotations)
- **Relationships**:
  - Created via RestContract POST /api/ai/datasets/export
  - Progress updates via WebSocketTopic ai/training/progress
  - Uses VisionProcessing captured imagery
- **Validation Rules**:
  - Must support both COCO JSON and YOLO TXT formats
  - Simulation mode must complete exports within 5 seconds
  - Failed exports must provide detailed error information

### BrandAsset
- **Description**: Retro 1980s branding assets for WebUI
- **Identifiers**: `asset_id` (e.g., logo-main, icon-status, map-pin)
- **Fields**:
  - `file_name` (string, e.g., LawnBerryPi_logo.png)
  - `usage_contexts` (array of WebUIPage.slug references)
  - `format` (enum: png, svg)
  - `dimensions_px` (dict, width/height)
  - `color_palette` (array of hex colors)
  - `retro_theme_compliance` (boolean)
- **Relationships**:
  - Used by WebUIPage for consistent branding
  - Referenced in docs-hub for asset downloads
  - Enforces constitutional aesthetic requirements
- **Validation Rules**:
  - Assets must exist and be optimized for web delivery
  - Usage contexts must include dashboard and manual-control
  - Retro theme compliance must be maintained

---

## Entity Relationships Summary

### Core System Flow
```
SensorReading → NavigationState → MotorCommand
              ↓
           SafetySystem ← PowerSystem
```

### WebUI Communication Flow
```
RestContract ← WebUIPage → WebSocketTopic
      ↓              ↓           ↓
OperatorCredential  WebSocketHub  TelemetryStream
```

### AI Processing Flow
```
VisionProcessing → AIAccelerator → DatasetExportJob
       ↑                ↓              ↓
   Camera Service   ObjectDetection  BrandAsset
```

### Configuration Management
```
HardwareProfile → SystemConfiguration → OperationalData
       ↓                ↓                    ↓
Constitutional   User Preferences      Analytics
Requirements
```

All entities must support simulation mode (SIM_MODE=1) for complete CI/testing coverage without hardware dependencies.